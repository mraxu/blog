
安装pcre
官网：http://www.pcre.org/
下载相应版本的pcre
解压：tar -zxvf pcre-8.39.tar.gz


安装zlib
官网：http://www.zlib.net/
下载相应版本的zlib
解压：tar -zxvf zlib-1.2.8.tar.gz


安装openssl
官网：https://www.openssl.org/
下载相应版本的openssl
解压：tar -zxvf openssl-1.1.0b.tar.gz

安装nginx-rtmp-module
官网：https://github.com/arut/nginx-rtmp-module





编译参数
```bash
--prefix=/home/live/liveplatform/nginx-1.9 \
--with-http_stub_status_module \
--with-http_ssl_module \
--with-http_gzip_static_module \
--with-http_realip_module \
--with-http_mp4_module \
--with-http_flv_module \
--with-pcre=/home/live/liveplatform/pcre-8.39 \
--with-zlib=/home/live/liveplatform/zlib-1.2.8 \
--with-openssl=/home/live/liveplatform/package/openssl-1.0.0t \
--add-module=/home/live/liveplatform/nginx-rtmp-module-1.1.10

```


配置文件

```nginx

# 配置系统用户
user  live;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}

# rtmp服务
rtmp {  
    server {  

        # rtmp服务监听端口
        listen 1935;  
        chunk_size 4096;

        #log_format new '$remote_addr';
        #access_log logs/rtmp_access.log new;
        #access_log logs/rtmp_access.log;
        #access_log off;

        # rtmp协议推流应用
        application myapp {  
            live on;  
            record off;
            recorder rec1 {
                record all;
                record_path /tmp/rec;
                record_suffix -%d-%b-%y-%H-%M-%S.flv;
                record_unique on;
                exec_record_done yamdi -i $path -o /home/live/liveplatform/nginx-1.9/aout.flv;
                exec_record_done echo $path >>/home/live/liveplatform/nginx-1.9/logs/record.log;
            }               

        }

        # video on demand
        application vod {
            play /tmp/rec;
        }

        application vod_http {
            play http://112.64.196.234/vod;
        }

        # hls推流应用
        application hls {  
            live on;  
            hls on;
            # 每个ts文件的视频时长
            hls_fragment 1s;
            # hls临时文件地址
            hls_path /tmp/hls;
            # 视频永久存储
            recorder rec1 {
                record all;
                #record_max_size 64K;
                record_path /tmp/rec;
                record_suffix -%d-%b-%y-%H-%M-%S.flv;
                record_unique on;
                # 存储完成之后执行的命令
                exec_record_done yamdi -i $path -o /home/live/liveplatform/nginx-1.9/aout.flv;
                exec_record_done echo $path >>/home/live/liveplatform/nginx-1.9/logs/record.log;
            }

            #recorder chunked {
                #record all;
                #record_max_size 6200K;
                #record_interval 10s;
                #record_suffix -%Y-%m-%d-%H_%M_%S.flv;
                #record_path /tmp/rec/Chunked;
            #}
        }  
    }  
}  

http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  112.64.196.234;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   html;
            index  index.html index.htm;
        }

        # 配置视频播放
        location ~ \.flv {
            flv;
        }

        #location ~ \.mp4 {
        #    mp4;
        #}

        # 配置rtmp监控
        location /stat {  
            rtmp_stat all;  
            rtmp_stat_stylesheet stat.xsl;  
        }  

        location /stat.xsl {  
            root /home/live/liveplatform/nginx-rtmp-module-1.1.10/;  
        }  

        location /control {  
            rtmp_control all;  
        }  

        # 配置hls的http接收
        location /hls {  
            types {  
                application/vnd.apple.mpegurl m3u8;  
                video/mp2t ts;  
            }  
            root /tmp;  
            add_header Cache-Control no-cache;  
            expires -1;  
        }  

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}
```


安装yamdi
yadmi的作用是为flv文件添加关键帧，才能实现拖动播放

```
#下载yadmi
wget http://sourceforge.net/projects/yamdi/files/yamdi/1.4/yamdi-1.4.tar.gz/download
#安装yadmi
tar xzvf yamdi-1.4.tar.gz
cd yamdi-1.4
make && make install
使用方法：yamdi -i input.flv -o out.flv
给input.flv文件 添加关键帧，输出为out.flv文件
```


hls播放

```html
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>

<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
        <div style="text-align: center;">
                <h1>Welcome to live platform!</h1><p>.</p>

                <video id=example-video width=600 height=300  controls autoplay webkit-playsinline>  
                        <source src="http://112.64.196.234:80/hls/test1.m3u8" type="application/vnd.apple.mpegurl" />  
                        <p class="warning">Your browser does not support HTML5 video.</p>  
                </video>
        </div>
<script>

</script>
</body>
</html>
```


flash播放

```html
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="//cdn.bootcss.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" rel="stylesheet">

<style>

</style>

<script src="js/swfobject.js"></script>
<script src="js/jquery/jquery-2.1.4.min.js"></script>
</head>
<body>
        <div style="text-align: center;">
                <h1>Welcome to live platform!</h1>

                <div id="moviePlayerWapper" style="background:#000;width:770px;height:380px;"></div>
                <br/>
                <div class="input-group input-group-lg" style="width: 800px;margin-left: auto;margin-right: auto;">
                        <input type="text" id="m3u8" class="form-control" placeholder="Username"
                        value="http://112.64.196.234:80/hls/test1.m3u8"/>
                        <span class="input-group-addon">
                        <a href="javascript:play();">播放</a>
                </div>
        </div>
<script>
        var play = function() {
                var m3u8 = document.getElementById('m3u8').value;;
                var flashvars = {
                         //M3U8 url, or any other url which compatible with SMP player (flv, mp4, f4m)         
                         // escaped it for urls with ampersands         
                         src: escape(m3u8),
                         // url to OSMF HLS Plugin        
                         plugin_m3u8: "swf/HLSProviderOSMF.swf",
                };
                var params = {
                        // self-explained parameters         
                        allowFullScreen: true,
                        allowScriptAccess: "always",
                        bgcolor: "#000000"
                };
                var attrs = {
                        name: "player"
                };

                swfobject.embedSWF(
                        // url to SMP player         
                        "swf/StrobeMediaPlayback.swf",
                        // div id where player will be place         
                        "moviePlayerWapper",
                        // width, height         
                        "800", "485",
                        // minimum flash player version required         
                        "10.2",
                        // other parameters         
                        null, flashvars, params, attrs
                );
        };
        $(function() {
                play();
        });

</script>
</body>
</html>
```





参考资料：
从0到1打造直播 App：http://dev.qq.com/topic/5811d42e7fd6ec467453bf58
m3u8的浏览器播放器（flash）:https://www.the5fire.com/m3u8-web-player.html
使用 nginx 和 rtmp 插件搭建视频直播和点播服务器:http://www.tuicool.com/articles/iauQNr
